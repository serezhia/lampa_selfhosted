# Multi-stage build –¥–ª—è Lampa Web —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏–∑ GitHub

# Stage 1: Build
FROM node:lts AS build

WORKDIR /app

# –ö–ª–æ–Ω–∏—Ä—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π lampa-source
ARG LAMPA_REPO=https://github.com/yumata/lampa-source.git
ARG LAMPA_BRANCH=main
ARG DOMAIN=example.com

RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*
RUN git clone --depth 1 --branch ${LAMPA_BRANCH} ${LAMPA_REPO} .

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø–∞—Ç—á–µ–π –∏ build —Å–∫—Ä–∏–ø—Ç
COPY patches.json apply-modifications.js build.js ./

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN npm install

# –ó–∞–º–µ–Ω—è–µ–º placeholder –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –¥–æ–º–µ–Ω
RUN sed -i "s/REPLACE_WITH_DOMAIN/${DOMAIN}/g" patches.json

# –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–∞—Ç—á–∏ –∫ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞–º –ü–ï–†–ï–î —Å–±–æ—Ä–∫–æ–π
RUN node apply-modifications.js

# –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç (–ø–∞—Ç—á–∏ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫ src —Ñ–∞–π–ª–∞–º)
RUN node build.js

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞
RUN if [ ! -d "build/github/lampa" ]; then \
    echo "‚ùå Build output not found!"; \
    ls -la build/ || true; \
    exit 1; \
    fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–∞—Ç—á–∏ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å

RUN echo "üîç Checking if patches applied for domain: ${DOMAIN}" && \
    if grep -q "${DOMAIN}" build/github/lampa/app.min.js; then \
    echo "‚úÖ Patches applied successfully!"; \
    grep -c "${DOMAIN}" build/github/lampa/app.min.js; \
    else \
    echo "‚ùå Patches NOT applied!"; \
    exit 1; \
    fi

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Å–±–æ—Ä–∫–∏
RUN mkdir -p /build_output && \
    cp -r build/github/lampa/* /build_output/

# Stage 2: Nginx
FROM nginx:alpine

# –£–¥–∞–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã nginx
RUN rm -rf /usr/share/nginx/html/*

# –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
WORKDIR /usr/share/nginx/html
COPY --from=build /build_output/ ./

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –ø–ª–∞–≥–∏–Ω–æ–≤ (–±—É–¥—É—Ç –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ volume)
RUN mkdir -p /plugins/builtin /plugins/custom /usr/share/nginx/html/plugins

# –ö–æ–ø–∏—Ä—É–µ–º entrypoint —Å–∫—Ä–∏–ø—Ç
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ modification.js –≤ index.html
# –í—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–≥ <script> –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–º </body>
RUN if [ -f index.html ]; then \
    sed -i 's|</body>|<script src="plugins/modification.js"></script>\n</body>|' index.html; \
    fi

EXPOSE 80

# –ò—Å–ø–æ–ª—å–∑—É–µ–º entrypoint –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ –ø–ª–∞–≥–∏–Ω–æ–≤
ENTRYPOINT ["/entrypoint.sh"]
